# Sheep Music API - Postman 测试指南

## 📦 导入 Postman Collection

### 步骤 1：导入 Collection
1. 打开 Postman
2. 点击左上角 **"Import"** 按钮
3. 选择 **"File"** 选项卡
4. 点击 **"Upload Files"**
5. 选择文件：`Sheep-Music-API.postman_collection.json`
6. 点击 **"Import"**

### 步骤 2：导入 Environment
1. 点击右上角 **齿轮图标⚙️** → **"Manage Environments"**
2. 点击 **"Import"** 按钮
3. 选择文件：`Sheep-Music-Local.postman_environment.json`
4. 点击 **"Import"**
5. 关闭弹窗
6. 在右上角环境下拉框中选择 **"Sheep Music - Local"**

---

## 🚀 测试流程（按顺序执行）

### 第 1 步：用户认证

#### 1.1 管理员登录
- 请求：`1. 用户认证 → 1.1 管理员登录`
- 点击 **"Send"**
- ✅ 成功后，`token` 会**自动保存**到环境变量

**验证**：
- 状态码：200
- 返回：`{ "code": 200, "data": { "token": "...", "userInfo": {...} } }`
- 环境变量 `{{token}}` 已自动填充

---

### 第 2 步：创建歌手

#### 2.1 创建歌手
- 请求：`2. 歌手管理 → 2.1 创建歌手`
- 点击 **"Send"**
- ✅ 成功后，`artistId` 会**自动保存**到环境变量

**验证**：
- 状态码：200
- 返回：`{ "code": 200, "data": { "id": 1, "name": "周杰伦", ... } }`
- 环境变量 `{{artistId}}` 已自动填充

#### 2.2 获取歌手列表（验证）
- 请求：`2. 歌手管理 → 2.2 获取歌手列表`
- 点击 **"Send"**
- 应该能看到刚创建的歌手

---

### 第 3 步：上传文件

#### 3.1 上传音乐文件
- 请求：`3. 文件上传 → 3.1 上传音乐文件`
- 点击 **"Body"** 选项卡
- 点击 **"Select Files"** 选择你的 MP3 文件（例如：爱你没差-周杰伦.mp3）
- 点击 **"Send"**
- ✅ 成功后，`musicUrl` 会**自动保存**到环境变量

**验证**：
- 状态码：200
- 返回：`{ "code": 200, "data": { "url": "https://...", ... } }`
- 环境变量 `{{musicUrl}}` 已自动填充

#### 3.2 上传封面图片
- 请求：`3. 文件上传 → 3.2 上传封面图片`
- 点击 **"Body"** 选项卡
- 点击 **"Select Files"** 选择封面图片
- 点击 **"Send"**
- ✅ 成功后，`coverUrl` 会**自动保存**到环境变量

**验证**：
- 状态码：200
- 返回：`{ "code": 200, "data": { "url": "https://...", ... } }`
- 环境变量 `{{coverUrl}}` 已自动填充

---

### 第 4 步：创建歌曲

#### 4.1 创建歌曲
- 请求：`4. 歌曲管理 → 4.1 创建歌曲`
- **注意**：请求体中已自动使用环境变量：
  - `{{artistId}}` - 步骤 2.1 保存的歌手 ID
  - `{{musicUrl}}` - 步骤 3.1 保存的音乐 URL
  - `{{coverUrl}}` - 步骤 3.2 保存的封面 URL
- 点击 **"Send"**
- ✅ 成功后，`songId` 会**自动保存**到环境变量

**请求体示例**：
```json
{
  "title": "爱你没差",
  "artistId": {{artistId}},
  "artistName": "周杰伦",
  "duration": 245,
  "cover": "{{coverUrl}}",
  "url": "{{musicUrl}}",
  "lyric": "[00:00.00]爱你没差\n[00:05.00]周杰伦",
  "status": 1
}
```

**验证**：
- 状态码：200
- 返回：`{ "code": 200, "data": { "id": 1, "title": "爱你没差", ... } }`
- 环境变量 `{{songId}}` 已自动填充

#### 4.2 获取歌曲列表（验证）
- 请求：`4. 歌曲管理 → 4.2 获取歌曲列表`
- 点击 **"Send"**
- 应该能看到刚创建的歌曲

---

### 第 5 步：用户端接口测试

#### 5.1 获取最新歌曲
- 请求：`5. 音乐浏览 → 5.1 获取最新歌曲`
- 点击 **"Send"**

#### 5.2 搜索歌曲
- 请求：`5. 音乐浏览 → 5.3 搜索歌曲`
- 点击 **"Send"**
- 应该能搜索到"爱你"相关的歌曲

#### 5.3 播放歌曲
- 请求：`5. 音乐浏览 → 5.5 播放歌曲`
- 点击 **"Send"**
- 播放次数 +1

#### 5.4 验证播放次数
- 请求：`5. 音乐浏览 → 5.4 获取歌曲详情`
- 点击 **"Send"**
- 检查 `playCount` 字段，应该变成 1

---

## 🔄 自动化功能

### 自动保存环境变量

Collection 中已配置了自动化脚本，以下变量会自动保存：

| 变量名 | 来源请求 | 用途 |
|--------|---------|------|
| `token` | 1.1 管理员登录 | 所有需要认证的请求 |
| `artistId` | 2.1 创建歌手 | 创建歌曲时使用 |
| `musicUrl` | 3.1 上传音乐文件 | 创建歌曲时使用 |
| `coverUrl` | 3.2 上传封面图片 | 创建歌曲时使用 |
| `songId` | 4.1 创建歌曲 | 获取/更新/删除歌曲时使用 |

### 查看环境变量
1. 点击右上角 **眼睛图标👁️**
2. 查看当前环境变量的值

---

## 📋 测试检查清单

### 必测接口（按顺序）

- [ ] 1.1 管理员登录（获取 Token）
- [ ] 2.1 创建歌手（获取 artistId）
- [ ] 3.1 上传音乐文件（获取 musicUrl）
- [ ] 3.2 上传封面图片（获取 coverUrl）
- [ ] 4.1 创建歌曲
- [ ] 4.2 获取歌曲列表
- [ ] 5.1 获取最新歌曲
- [ ] 5.3 搜索歌曲
- [ ] 5.5 播放歌曲

### 选测接口

- [ ] 2.2 获取歌手列表
- [ ] 2.3 获取所有歌手
- [ ] 4.3 获取歌曲详情
- [ ] 4.4 更新歌曲
- [ ] 4.5 删除歌曲
- [ ] 5.2 获取热门歌曲
- [ ] 5.6 获取歌手列表
- [ ] 5.7 根据歌手获取歌曲

---

## 🐛 常见问题

### 问题 1：401 Unauthorized
**原因**：Token 未设置或已过期

**解决**：
1. 重新执行 `1.1 管理员登录`
2. 确认环境变量 `{{token}}` 已自动填充
3. 确认右上角环境选择为 **"Sheep Music - Local"**

### 问题 2：上传文件失败
**原因**：OSS 配置错误或权限不足

**解决**：
1. 检查 `application.yml` 中的 OSS 配置
2. 检查 AccessKey 是否有 PutObject 权限
3. 查看后端控制台的错误日志

### 问题 3：创建歌曲时 artistId 为空
**原因**：环境变量未自动保存

**解决**：
1. 重新执行 `2.1 创建歌手`
2. 点击右上角眼睛图标，检查 `{{artistId}}` 是否有值
3. 如果没有值，手动复制歌手 ID 填入请求体

---

## 💡 使用技巧

### 1. 批量测试
- 选中 Collection 或文件夹
- 点击右键 → **"Run"**
- 选择要运行的请求
- 点击 **"Run Sheep Music API"**

### 2. 查看请求历史
- 左侧 **"History"** 选项卡
- 可以查看所有历史请求

### 3. 保存响应示例
- 发送请求后
- 点击 **"Save Response"**
- 选择 **"Save as example"**
- 方便后续参考

### 4. 导出测试结果
- 运行 Collection 后
- 点击 **"Export Results"**
- 可以导出测试报告

---

## 🎯 下一步

测试通过后，可以：
1. ✅ 验证所有核心功能正常
2. ✅ 开始开发前端管理后台
3. ✅ 集成前后端

---

## 📞 帮助

如果遇到问题：
1. 检查后端控制台日志
2. 检查 Postman Console（底部，View → Show Postman Console）
3. 查看响应的错误信息
4. 联系开发者

