# 📊 部署工作流程

可视化的完整部署流程。

---

## 🔄 完整部署流程

```
┌─────────────────────────────────────────────────────────────┐
│                    本地开发环境 (Windows)                      │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1. 前端构建                                                  │
│     cd front/sheep-music                                    │
│     npm install --legacy-peer-deps                          │
│     npm run build                                           │
│     ✓ 生成 dist/ 目录                                        │
│                                                             │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│                    WSL (Ubuntu on Windows)                   │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  2. Git 提交与推送                                            │
│     cd /mnt/e/java-project/project1                        │
│     git add .                                              │
│     git commit -m "Prepare for deployment"                 │
│     git push origin main                                   │
│     ✓ 代码上传到 GitHub                                      │
│                                                             │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│                       GitHub                                 │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  3. 代码托管                                                  │
│     ✓ 前端代码 (含 dist/)                                    │
│     ✓ 后端代码                                               │
│     ✓ Docker 配置                                            │
│     ✓ 数据库脚本                                             │
│                                                             │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│              阿里云 ECS (Ubuntu 20.04)                        │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  4. 连接服务器                                                │
│     □ Workbench (Web 端)                                    │
│     □ SSH (命令行)                                           │
│                                                             │
│  5. 克隆项目                                                  │
│     cd /opt                                                │
│     git clone <repo-url> sheep-music                       │
│     cd sheep-music                                         │
│                                                             │
│  6. Docker 部署                                              │
│     docker compose up -d --build                           │
│                                                             │
│     ┌─────────────────────────────────────┐                │
│     │    Docker Compose 编排               │                │
│     ├─────────────────────────────────────┤                │
│     │                                     │                │
│     │  ┌──────────────────────────────┐  │                │
│     │  │  MySQL 容器                   │  │                │
│     │  │  - 端口: 3306                 │  │                │
│     │  │  - 数据卷: mysql-data         │  │                │
│     │  │  - 健康检查: ✓                │  │                │
│     │  └──────────────────────────────┘  │                │
│     │              ▲                      │                │
│     │              │                      │                │
│     │  ┌───────────┴──────────────────┐  │                │
│     │  │  后端容器 (Spring Boot)       │  │                │
│     │  │  - 端口: 8080 -> 9000        │  │                │
│     │  │  - Maven 构建                │  │                │
│     │  │  - JPA + MySQL               │  │                │
│     │  └──────────────────────────────┘  │                │
│     │              ▲                      │                │
│     │              │                      │                │
│     │  ┌───────────┴──────────────────┐  │                │
│     │  │  前端容器 (Nginx)             │  │                │
│     │  │  - 端口: 80                  │  │                │
│     │  │  - 静态文件: dist/           │  │                │
│     │  │  - 反向代理: /api -> backend │  │                │
│     │  └──────────────────────────────┘  │                │
│     │                                     │                │
│     └─────────────────────────────────────┘                │
│                                                             │
│  7. 验证部署                                                  │
│     docker compose ps                                      │
│     curl http://localhost                                  │
│     curl http://localhost:8080                             │
│     ✓ 所有容器运行正常                                        │
│                                                             │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│                   公网访问 (浏览器)                           │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  8. 用户访问                                                  │
│     http://8.153.206.169        (前端页面)                  │
│     http://8.153.206.169:8080   (后端API)                   │
│                                                             │
│  ┌───────────────────────────────────────────────────┐     │
│  │              网络请求流程                          │     │
│  ├───────────────────────────────────────────────────┤     │
│  │                                                   │     │
│  │  用户浏览器                                        │     │
│  │       │                                           │     │
│  │       ▼                                           │     │
│  │  前端 (80端口)                                     │     │
│  │       │                                           │     │
│  │       ├──► 静态资源 (HTML/CSS/JS)                 │     │
│  │       │                                           │     │
│  │       └──► API 请求 (/api/*)                      │     │
│  │              │                                     │     │
│  │              ▼                                     │     │
│  │         Nginx 反向代理                             │     │
│  │              │                                     │     │
│  │              ▼                                     │     │
│  │         后端 (9000端口)                            │     │
│  │              │                                     │     │
│  │              ▼                                     │     │
│  │         MySQL 数据库                               │     │
│  │                                                   │     │
│  └───────────────────────────────────────────────────┘     │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 🔐 安全配置检查

```
防火墙配置
├── 服务器防火墙 (ufw)
│   ├── 80/tcp   ✓ 允许
│   ├── 8080/tcp ✓ 允许
│   └── 3306/tcp ✗ 建议关闭（仅容器内部访问）
│
└── 阿里云安全组
    ├── 入方向规则
    │   ├── 80/tcp   → 0.0.0.0/0 (所有人可访问)
    │   ├── 8080/tcp → 0.0.0.0/0 (所有人可访问)
    │   └── 3306/tcp → 限制IP (可选，不建议公开)
    │
    └── 出方向规则
        └── 全部允许 (默认)
```

---

## 📁 项目文件结构

```
sheep-music/
├── 📄 docker-compose.yml          # Docker 编排配置
├── 📄 deploy.sh                   # 部署脚本
├── 📄 env.template                # 环境变量模板
│
├── 📁 front/sheep-music/          # 前端项目
│   ├── 📁 dist/                   # ⭐ 构建输出（必须提交）
│   │   ├── index.html
│   │   ├── favicon.ico
│   │   └── assets/                # JS/CSS 文件
│   ├── 📄 Dockerfile              # 前端 Docker 配置
│   ├── 📄 nginx.conf              # Nginx 配置
│   ├── 📄 vite.config.js          # Vite 配置
│   ├── 📄 index.html              # Vite 入口
│   └── 📄 package.json            # Node 依赖
│
├── 📁 back/music-project/         # 后端项目
│   ├── 📁 src/                    # 源代码
│   ├── 📄 Dockerfile              # 后端 Docker 配置
│   ├── 📄 pom.xml                 # Maven 配置
│   └── 📄 database.sql            # 数据库初始化
│
└── 📁 docs/                       # 文档
    ├── WSL_DEPLOY.md
    ├── SERVER_DEPLOY.md
    └── QUICK_START.md
```

---

## 🎯 关键步骤时间估算

| 步骤 | 预计时间 | 说明 |
|------|---------|------|
| 本地前端构建 | 1-2 分钟 | `npm run build` |
| Git 提交推送 | 1 分钟 | 取决于网络速度 |
| 服务器克隆项目 | 1-2 分钟 | 取决于项目大小 |
| Docker 构建镜像 | 3-5 分钟 | 首次构建较慢 |
| 后端启动 | 30-60 秒 | Spring Boot 初始化 |
| MySQL 启动 | 10-20 秒 | 数据库初始化 |
| 前端启动 | 5-10 秒 | Nginx 启动很快 |
| **总计** | **8-12 分钟** | 首次部署 |

后续更新部署：**3-5 分钟**

---

## 🔄 持续部署流程

```
代码修改
   │
   ▼
本地测试
   │
   ▼
前端构建 (npm run build)
   │
   ▼
Git 提交推送
   │
   ▼
服务器拉取 (git pull)
   │
   ▼
重新构建 (docker compose up -d --build)
   │
   ▼
验证更新
```

---

## 📊 监控检查点

### 部署前
- [ ] dist/ 目录已构建
- [ ] 代码已提交到 GitHub
- [ ] 安全组已配置

### 部署中
- [ ] Docker 安装成功
- [ ] 项目克隆成功
- [ ] 容器构建成功

### 部署后
- [ ] 所有容器运行
- [ ] 服务响应正常
- [ ] 浏览器访问成功

---

## 🎉 成功标志

✅ `docker compose ps` 显示所有容器为 running/healthy
✅ `curl http://localhost` 返回 HTML 内容
✅ `curl http://localhost:8080` 返回后端响应
✅ 浏览器访问前端显示完整页面（不是空白）
✅ 用户可以注册、登录、使用所有功能

---

**参考文档**:
- [快速开始](QUICK_START.md)
- [WSL 部署](WSL_DEPLOY.md)
- [服务器部署](SERVER_DEPLOY.md)


