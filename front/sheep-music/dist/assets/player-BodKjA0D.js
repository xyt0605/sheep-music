import{ag as e,r as l,c as a}from"./vue-vendor-BzZaYQKc.js";import{p as u}from"./song-C8TMBuSO.js";import{r}from"./request-76E38DvM.js";import{u as t}from"./index-Cb8xoRiw.js";const v=e=>r({url:"/api/user/play-history/list",method:"get",params:e}),s=()=>r({url:"/api/user/play-history/count",method:"get"}),o=()=>r({url:"/api/user/play-history/clear",method:"delete"}),i=e=>r({url:`/api/user/play-history/${e}`,method:"delete"}),n=e("player",()=>{const e=l(null),v=l([]),s=l(-1),o=l(!1),i=l(0),n=l(0),d=l(.7),c=l(!1),m=l(!1),p=l("list"),h=l(null),y=a(()=>s.value<v.value.length-1),g=a(()=>s.value>0),f=async(l,a=null,i=!1)=>{var n,d;try{if(a&&a.length>0){v.value=a;const e=a.findIndex(e=>e.id===l.id);s.value=e>=0?e:0}else if((null==(n=e.value)?void 0:n.id)!==l.id){const e=v.value.findIndex(e=>e.id===l.id);e>=0?s.value=e:(v.value.push(l),s.value=v.value.length-1)}if(e.value=l,c.value=!0,h.value&&l.url){i&&h.value.src.includes(l.url)?h.value.currentTime=0:h.value.src=l.url,await h.value.play(),o.value=!0;try{await u(l.id)}catch(m){console.error("更新播放次数失败:",m)}try{t().isLogin&&await(d={songId:l.id},r({url:"/api/user/play-history",method:"post",data:d}))}catch(m){console.error("添加播放历史失败:",m)}}}catch(m){console.error("播放失败:",m),o.value=!1}},x=()=>{h.value&&(h.value.pause(),o.value=!1)},P=()=>{h.value&&(h.value.play(),o.value=!0)},w=()=>{const e=(()=>{if(0===v.value.length)return-1;if("random"===p.value){if(1===v.value.length)return 0;let e;do{e=Math.floor(Math.random()*v.value.length)}while(e===s.value);return e}return s.value<v.value.length-1?s.value+1:0})();e>=0&&(s.value=e,f(v.value[e]))};return{currentSong:e,playlist:v,currentIndex:s,isPlaying:o,currentTime:i,duration:n,volume:d,showPlayer:c,showLyric:m,playMode:p,hasNextSong:y,hasPrevSong:g,initAudio:l=>{h.value=l,l.addEventListener("timeupdate",()=>{i.value=l.currentTime}),l.addEventListener("loadedmetadata",()=>{n.value=l.duration}),l.addEventListener("ended",()=>{"single"===p.value?e.value&&f(e.value,null,!0):w()}),l.volume=d.value},play:f,pause:x,resume:P,togglePlay:()=>{o.value?x():P()},next:w,prev:()=>{g.value&&(s.value--,f(v.value[s.value]))},seek:e=>{h.value&&(h.value.currentTime=e,i.value=e)},setVolume:e=>{d.value=e,h.value&&(h.value.volume=e)},addToPlaylist:e=>{v.value.some(l=>l.id===e.id)||v.value.push(e)},removeFromPlaylist:e=>{const l=v.value.findIndex(l=>l.id===e);l>=0&&(v.value.splice(l,1),l<s.value&&s.value--)},toggleLyric:()=>{m.value=!m.value},setPlayMode:e=>{p.value=e},togglePlayMode:()=>{const e=["list","random","single"],l=(e.indexOf(p.value)+1)%e.length;p.value=e[l]}}});export{s as a,o as c,i as d,v as g,n as u};
