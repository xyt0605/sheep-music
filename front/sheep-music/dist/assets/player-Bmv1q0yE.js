import{ad as F,g as s,k as L,f as N}from"./index-LKNASSCX.js";import{p as V}from"./song-FYgzkVSR.js";import{r as c}from"./request-BJQTzVY9.js";const q=u=>c({url:"/api/user/play-history",method:"post",data:u}),J=u=>c({url:"/api/user/play-history/list",method:"get",params:u}),K=()=>c({url:"/api/user/play-history/count",method:"get"}),Q=()=>c({url:"/api/user/play-history/clear",method:"delete"}),R=u=>c({url:`/api/user/play-history/${u}`,method:"delete"}),W=F("player",()=>{const u=s(null),l=s([]),t=s(-1),i=s(!1),y=s(0),m=s(0),f=s(.7),g=s(!1),p=s(!1),v=s("list"),a=s(null),w=L(()=>t.value<l.value.length-1),x=L(()=>t.value>0),T=e=>{a.value=e,e.addEventListener("timeupdate",()=>{y.value=e.currentTime}),e.addEventListener("loadedmetadata",()=>{m.value=e.duration}),e.addEventListener("ended",()=>{v.value==="single"?u.value&&d(u.value,null,!0):M()}),e.volume=f.value},d=async(e,o=null,n=!1)=>{var S;try{if(o&&o.length>0){l.value=o;const r=o.findIndex(h=>h.id===e.id);t.value=r>=0?r:0}else if(((S=u.value)==null?void 0:S.id)!==e.id){const r=l.value.findIndex(h=>h.id===e.id);r>=0?t.value=r:(l.value.push(e),t.value=l.value.length-1)}if(u.value=e,g.value=!0,a.value&&e.url){n&&a.value.src.includes(e.url)?a.value.currentTime=0:a.value.src=e.url,await a.value.play(),i.value=!0;try{await V(e.id)}catch(r){console.error("更新播放次数失败:",r)}try{N().isLogin&&await q({songId:e.id})}catch(r){console.error("添加播放历史失败:",r)}}}catch(r){console.error("播放失败:",r),i.value=!1}},P=()=>{a.value&&(a.value.pause(),i.value=!1)},I=()=>{a.value&&(a.value.play(),i.value=!0)},H=()=>{i.value?P():I()},k=()=>{if(l.value.length===0)return-1;if(v.value==="random"){if(l.value.length===1)return 0;let e;do e=Math.floor(Math.random()*l.value.length);while(e===t.value);return e}else return t.value<l.value.length-1?t.value+1:0},M=()=>{const e=k();e>=0&&(t.value=e,d(l.value[e]))};return{currentSong:u,playlist:l,currentIndex:t,isPlaying:i,currentTime:y,duration:m,volume:f,showPlayer:g,showLyric:p,playMode:v,hasNextSong:w,hasPrevSong:x,initAudio:T,play:d,pause:P,resume:I,togglePlay:H,next:M,prev:()=>{x.value&&(t.value--,d(l.value[t.value]))},seek:e=>{a.value&&(a.value.currentTime=e,y.value=e)},setVolume:e=>{f.value=e,a.value&&(a.value.volume=e)},addToPlaylist:e=>{l.value.some(n=>n.id===e.id)||l.value.push(e)},removeFromPlaylist:e=>{const o=l.value.findIndex(n=>n.id===e);o>=0&&(l.value.splice(o,1),o<t.value&&t.value--)},toggleLyric:()=>{p.value=!p.value},setPlayMode:e=>{v.value=e},togglePlayMode:()=>{const e=["list","random","single"],n=(e.indexOf(v.value)+1)%e.length;v.value=e[n]}}});export{K as a,Q as c,R as d,J as g,W as u};
