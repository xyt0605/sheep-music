import{_ as N,c as M,o as R,a as d,d as o,w as s,r as f,f as H,g as _,k as J,h as z,E as c,e as u,t as b,q as B}from"./index-LKNASSCX.js";import{u as q,a as O}from"./user-CatBsr9t.js";import"./request-BJQTzVY9.js";const T={name:"Profile",setup(){const p=H(),a=_(null),V=_(null),e=_(!1),y=_(!1),h=_(!1),P=_(!1),n=_(!1),U="/api/upload/avatar",k=J(()=>({Authorization:`Bearer ${localStorage.getItem("token")}`})),w=z({nickname:"",email:"",avatar:""}),i=z({oldPassword:"",newPassword:"",confirmPassword:""});return{userStore:p,editFormRef:a,passwordFormRef:V,editDialogVisible:e,passwordDialogVisible:y,editLoading:h,passwordLoading:P,uploadLoading:n,uploadAction:U,uploadHeaders:k,editForm:w,passwordForm:i,editRules:{nickname:[{required:!0,message:"请输入昵称",trigger:"blur"},{min:1,max:50,message:"昵称长度为1-50个字符",trigger:"blur"}],email:[{validator:(r,t,m)=>{t&&!/^[\w-]+(\.[\w-]+)*@[\w-]+(\.[\w-]+)+$/.test(t)?m(new Error("邮箱格式不正确")):m()},trigger:"blur"}]},passwordRules:{oldPassword:[{required:!0,message:"请输入旧密码",trigger:"blur"}],newPassword:[{required:!0,message:"请输入新密码",trigger:"blur"},{min:6,max:20,message:"密码长度为6-20个字符",trigger:"blur"}],confirmPassword:[{required:!0,message:"请再次输入新密码",trigger:"blur"},{validator:(r,t,m)=>{t!==i.newPassword?m(new Error("两次输入的密码不一致")):m()},trigger:"blur"}]},formatDate:r=>r?new Date(r).toLocaleDateString("zh-CN"):"未知",showEditDialog:()=>{var r,t,m;w.nickname=((r=p.userInfo)==null?void 0:r.nickname)||"",w.email=((t=p.userInfo)==null?void 0:t.email)||"",w.avatar=((m=p.userInfo)==null?void 0:m.avatar)||"",e.value=!0},showPasswordDialog:()=>{i.oldPassword="",i.newPassword="",i.confirmPassword="",y.value=!0},handleEditSubmit:async()=>{a.value&&await a.value.validate(async r=>{if(r)try{h.value=!0;const t=await q({nickname:w.nickname,email:w.email||null,avatar:w.avatar||null});p.setUserInfo(t.data),c.success("资料更新成功"),e.value=!1}catch(t){c.error(t.message||"更新失败")}finally{h.value=!1}})},handlePasswordSubmit:async()=>{V.value&&await V.value.validate(async r=>{if(r)try{P.value=!0,await O({oldPassword:i.oldPassword,newPassword:i.newPassword}),c.success("密码修改成功"),y.value=!1,i.oldPassword="",i.newPassword="",i.confirmPassword=""}catch(t){c.error(t.message||"修改失败")}finally{P.value=!1}})},beforeAvatarUpload:r=>{const t=r.type.startsWith("image/"),m=r.size/1024/1024<2;return t?m?!0:(c.error("图片大小不能超过 2MB!"),!1):(c.error("只能上传图片文件!"),!1)},handleUploadProgress:()=>{n.value=!0},handleAvatarSuccess:r=>{n.value=!1;const t=r&&r.data&&r.data.url||r&&r.url;if(t){const m={...p.userInfo,avatar:t};p.setUserInfo(m),q({avatar:t}).then(()=>{c.success("头像更新成功")}).catch(()=>{c.warning("头像显示成功，但同步失败，请刷新页面")})}else c.error(r&&r.message||"上传失败，请重试")},handleUploadError:r=>{n.value=!1;try{const t=JSON.parse(r.message);c.error(t.message||"上传失败")}catch{c.error("上传失败")}}}}},W={class:"profile-page"},j={class:"user-info-card"},G={class:"user-basic-info"},K={class:"avatar-container"},Q={class:"user-details"},X={class:"username"},Y={class:"info-list"},Z={class:"info-item"},$={class:"value"},ee={class:"info-item"},ae={class:"value"},oe={class:"actions"},se={class:"avatar-edit"},le={class:"avatar-actions"},re={class:"dialog-footer"},te={class:"dialog-footer"};function de(p,a,V,e,y,h){const P=f("el-avatar"),n=f("el-button"),U=f("el-upload"),k=f("el-tag"),w=f("el-divider"),i=f("el-card"),g=f("el-input"),v=f("el-form-item"),L=f("el-text"),F=f("el-form"),S=f("el-dialog");return R(),M("div",W,[a[21]||(a[21]=d("div",{class:"page-header"},[d("h2",null,"👤 个人中心"),d("p",{class:"subtitle"},"管理你的个人信息")],-1)),d("div",j,[o(i,{shadow:"hover"},{default:s(()=>{var l,D,E,I,x;return[d("div",G,[d("div",K,[o(P,{size:100,src:(l=e.userStore.userInfo)==null?void 0:l.avatar},{default:s(()=>{var C,A;return[u(b((A=(C=e.userStore.userInfo)==null?void 0:C.nickname)==null?void 0:A.charAt(0)),1)]}),_:1},8,["src"]),o(U,{class:"avatar-uploader",action:e.uploadAction,headers:e.uploadHeaders,"show-file-list":!1,"on-success":e.handleAvatarSuccess,"before-upload":e.beforeAvatarUpload,"on-progress":e.handleUploadProgress,"on-error":e.handleUploadError},{default:s(()=>[o(n,{size:"small",type:"primary",loading:e.uploadLoading},{default:s(()=>[u(b(e.uploadLoading?"上传中...":"更换头像"),1)]),_:1},8,["loading"])]),_:1},8,["action","headers","on-success","before-upload","on-progress","on-error"])]),d("div",Q,[d("h3",null,b((D=e.userStore.userInfo)==null?void 0:D.nickname),1),d("p",X,"@"+b((E=e.userStore.userInfo)==null?void 0:E.username),1),e.userStore.isAdmin?(R(),B(k,{key:0,type:"danger",size:"small"},{default:s(()=>[...a[10]||(a[10]=[u("管理员",-1)])]),_:1})):(R(),B(k,{key:1,type:"success",size:"small"},{default:s(()=>[...a[11]||(a[11]=[u("普通用户",-1)])]),_:1}))])]),o(w),d("div",Y,[d("div",Z,[a[12]||(a[12]=d("span",{class:"label"},"邮箱：",-1)),d("span",$,b(((I=e.userStore.userInfo)==null?void 0:I.email)||"未设置"),1)]),d("div",ee,[a[13]||(a[13]=d("span",{class:"label"},"注册时间：",-1)),d("span",ae,b(e.formatDate((x=e.userStore.userInfo)==null?void 0:x.createdAt)),1)])]),o(w),d("div",oe,[o(n,{type:"primary",onClick:e.showEditDialog},{default:s(()=>[...a[14]||(a[14]=[u("编辑资料",-1)])]),_:1},8,["onClick"]),o(n,{onClick:e.showPasswordDialog},{default:s(()=>[...a[15]||(a[15]=[u("修改密码",-1)])]),_:1},8,["onClick"])])]}),_:1})]),o(S,{modelValue:e.editDialogVisible,"onUpdate:modelValue":a[4]||(a[4]=l=>e.editDialogVisible=l),title:"编辑资料",width:"500px","close-on-click-modal":!1},{footer:s(()=>[d("span",re,[o(n,{onClick:a[3]||(a[3]=l=>e.editDialogVisible=!1)},{default:s(()=>[...a[17]||(a[17]=[u("取消",-1)])]),_:1}),o(n,{type:"primary",loading:e.editLoading,onClick:e.handleEditSubmit},{default:s(()=>[...a[18]||(a[18]=[u(" 确定 ",-1)])]),_:1},8,["loading","onClick"])])]),default:s(()=>[o(F,{ref:"editFormRef",model:e.editForm,rules:e.editRules,"label-width":"80px"},{default:s(()=>[o(v,{label:"昵称",prop:"nickname"},{default:s(()=>[o(g,{modelValue:e.editForm.nickname,"onUpdate:modelValue":a[0]||(a[0]=l=>e.editForm.nickname=l),placeholder:"请输入昵称",maxlength:"50","show-word-limit":""},null,8,["modelValue"])]),_:1}),o(v,{label:"邮箱",prop:"email"},{default:s(()=>[o(g,{modelValue:e.editForm.email,"onUpdate:modelValue":a[1]||(a[1]=l=>e.editForm.email=l),placeholder:"请输入邮箱",type:"email"},null,8,["modelValue"])]),_:1}),o(v,{label:"头像",prop:"avatar"},{default:s(()=>[d("div",se,[o(P,{size:80,src:e.editForm.avatar},{default:s(()=>{var l;return[u(b((l=e.editForm.nickname)==null?void 0:l.charAt(0)),1)]}),_:1},8,["src"]),d("div",le,[o(g,{modelValue:e.editForm.avatar,"onUpdate:modelValue":a[2]||(a[2]=l=>e.editForm.avatar=l),placeholder:"头像URL（可选，建议使用上传功能）",type:"url",style:{"margin-bottom":"10px"}},null,8,["modelValue"]),o(L,{type:"info",size:"small"},{default:s(()=>[...a[16]||(a[16]=[u('提示：关闭对话框后，可点击个人中心的"更换头像"按钮上传图片',-1)])]),_:1})])])]),_:1})]),_:1},8,["model","rules"])]),_:1},8,["modelValue"]),o(S,{modelValue:e.passwordDialogVisible,"onUpdate:modelValue":a[9]||(a[9]=l=>e.passwordDialogVisible=l),title:"修改密码",width:"500px","close-on-click-modal":!1},{footer:s(()=>[d("span",te,[o(n,{onClick:a[8]||(a[8]=l=>e.passwordDialogVisible=!1)},{default:s(()=>[...a[19]||(a[19]=[u("取消",-1)])]),_:1}),o(n,{type:"primary",loading:e.passwordLoading,onClick:e.handlePasswordSubmit},{default:s(()=>[...a[20]||(a[20]=[u(" 确定 ",-1)])]),_:1},8,["loading","onClick"])])]),default:s(()=>[o(F,{ref:"passwordFormRef",model:e.passwordForm,rules:e.passwordRules,"label-width":"100px"},{default:s(()=>[o(v,{label:"旧密码",prop:"oldPassword"},{default:s(()=>[o(g,{modelValue:e.passwordForm.oldPassword,"onUpdate:modelValue":a[5]||(a[5]=l=>e.passwordForm.oldPassword=l),type:"password",placeholder:"请输入旧密码","show-password":""},null,8,["modelValue"])]),_:1}),o(v,{label:"新密码",prop:"newPassword"},{default:s(()=>[o(g,{modelValue:e.passwordForm.newPassword,"onUpdate:modelValue":a[6]||(a[6]=l=>e.passwordForm.newPassword=l),type:"password",placeholder:"请输入新密码（6-20个字符）","show-password":""},null,8,["modelValue"])]),_:1}),o(v,{label:"确认新密码",prop:"confirmPassword"},{default:s(()=>[o(g,{modelValue:e.passwordForm.confirmPassword,"onUpdate:modelValue":a[7]||(a[7]=l=>e.passwordForm.confirmPassword=l),type:"password",placeholder:"请再次输入新密码","show-password":""},null,8,["modelValue"])]),_:1})]),_:1},8,["model","rules"])]),_:1},8,["modelValue"])])}const fe=N(T,[["render",de],["__scopeId","data-v-11f5fc9d"]]);export{fe as default};
