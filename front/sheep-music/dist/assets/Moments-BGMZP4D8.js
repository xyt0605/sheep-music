import{a8 as D,_ as Ce,g as we,h,j as Me,c as p,o as c,a as i,A as te,k as b,d as t,w as l,e as m,r as x,m as w,ah as be,a4 as Ie,F as X,D as j,aB as se,aC as G,aw as ne,E as S,u as Ve,X as oe,t as C,av as le,z as ae,ai as $e,O as Se}from"./index-CxpdbhCZ.js";const De=k=>D({url:"/moment",method:"post",data:k}),Te=k=>D({url:"/moment/friends",method:"get",params:k}),ze=k=>D({url:`/moment/${k}/like`,method:"post"}),Be=k=>D({url:"/moment/comment",method:"post",data:k}),Pe=(k,E)=>D({url:`/moment/${k}/comments`,method:"get",params:E}),Ee=k=>D({url:`/moment/${k}`,method:"delete"}),Re={class:"moments-page"},Ue={class:"page-header"},Le={class:"moments-list"},Ne={key:0,class:"empty-state"},Ae={class:"moment-header"},Fe={class:"header-info"},Oe={class:"user-name"},qe={class:"moment-time"},Je={class:"moment-content"},Xe={key:0,class:"moment-text"},je={key:1,class:"moment-share"},Ge=["onClick"],He={class:"image-error"},Ke={class:"share-info"},Qe={class:"share-title"},We={key:2,class:"moment-share"},Ye=["onClick"],Ze={class:"image-error"},et={class:"share-info"},tt={class:"share-title"},st={key:3,class:"moment-images"},nt={class:"moment-actions"},ot={class:"moment-comments-section"},lt={class:"comment-input"},at={class:"comment-actions"},it={class:"moment-comments"},rt={key:0,class:"empty-state"},ut={key:1,class:"comment-items"},dt={class:"comment-main"},ct={class:"comment-header"},vt={class:"comment-username"},ft={class:"comment-time"},pt={class:"comment-content"},_t={key:2,class:"load-more"},mt={key:0,class:"load-more"},gt={style:{"margin-top":"8px","text-align":"right"}},yt={__name:"Moments",setup(k){const E=Ve(),B=we(),V=h(!1),M=h([]),R=h(0),ie=h(20),U=h(!0),L=h(null),N=h(null),P=h({}),g=s=>(P.value[s]||(P.value[s]={items:[],loading:!1,hasMore:!0,page:0,size:3,posting:!1,input:""}),P.value[s]),T=h(!1),A=h(!1),_=h({type:"text",content:"",relatedId:null,visibility:"public"}),F=h(),H=h({}),re=(s,e)=>{H.value[s]=e},K=s=>{if(!s)return"";const e=new Date(s),a=new Date-e,r=Math.floor(a/1e3),d=Math.floor(r/60),f=Math.floor(d/60),v=Math.floor(f/24);return r<60?"刚刚":d<60?`${d}分钟前`:f<24?`${f}小时前`:v<7?`${v}天前`:e.toLocaleDateString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit"})},Q=s=>{if(!s)return[];try{return JSON.parse(s)}catch{return[]}},O=async(s=!1)=>{if(!V.value){s&&(R.value=0,M.value=[],U.value=!0),V.value=!0;try{const e=await Te({page:R.value,size:ie.value});if(e.code===200){const o=e.data;s?M.value=o.content||[]:M.value.push(...o.content||[]),U.value=!o.last,M.value.forEach(a=>{const r=P.value[a.id];(!r||r.items&&r.items.length===0)&&q(a.id,!0)})}}catch(e){console.error("加载动态失败:",e)}finally{V.value=!1}}},ue=()=>{R.value++,O()},de=async s=>{L.value=s.id;try{const e=await ze(s.id);e.code===200&&(s.likeCount=e.data?(s.likeCount||0)+1:Math.max(0,(s.likeCount||0)-1))}catch(e){console.error("点赞失败:",e)}finally{L.value=null}},ce=async s=>{g(s.id).items.length===0&&await q(s.id,!0)},q=async(s,e=!1)=>{var a,r;const o=g(s);if(!o.loading&&!(!e&&o.items.length>0)){e&&(o.page=0,o.items=[],o.hasMore=!0),o.loading=!0;try{const d=await Pe(s,{page:o.page,size:o.size});if(d.code===200){const f=((a=d.data)==null?void 0:a.content)||[];o.items=[...o.items,...f];const v=((r=d.data)==null?void 0:r.last)??!0;o.hasMore=!v,v||(o.page+=1)}}catch(d){console.error("加载评论失败:",d)}finally{o.loading=!1}}},ve=async s=>{var a,r,d,f;const e=g(s.id),o=(e.input||"").trim();if(!o){S.warning("请输入评论内容");return}if(!e.posting){e.posting=!0;try{const v=await Be({momentId:s.id,content:o});v.code===200&&(S.success("评论成功"),e.items.unshift({id:((a=v.data)==null?void 0:a.id)||Date.now(),content:o,createTime:new Date().toISOString(),userId:(r=B.userInfo)==null?void 0:r.id,username:(d=B.userInfo)==null?void 0:d.nickname,userAvatar:(f=B.userInfo)==null?void 0:f.avatar}),s.commentCount=(s.commentCount||0)+1,e.input="")}catch(v){console.error("发表评论失败:",v)}finally{e.posting=!1}}},fe=async s=>{try{await Se.confirm("确定要删除这条动态吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),N.value=s.id,(await Ee(s.id)).code===200&&(S.success("删除成功"),M.value=M.value.filter(o=>o.id!==s.id))}catch(e){e!=="cancel"&&console.error("删除失败:",e)}finally{N.value=null}},pe=async()=>{if(!_.value.content.trim()&&_.value.type==="text"){S.warning("请输入动态内容");return}A.value=!0;try{(await De(_.value)).code===200&&(S.success("发布成功"),T.value=!1,_.value={type:"text",content:"",relatedId:null,visibility:"public"},O(!0))}catch(s){console.error("发布动态失败:",s)}finally{A.value=!1}},_e=s=>{var e;return((e=B.userInfo)==null?void 0:e.id)===s.userId},me=s=>{S.info("歌曲详情页开发中...")},ge=s=>{E.push(`/playlist/${s}`)};Me(()=>{O(!0)});const ye=s=>{var f,v,I;const e=((f=F.value)==null?void 0:f.textarea)||((I=(v=F.value)==null?void 0:v.$refs)==null?void 0:I.textarea);if(!e){_.value.content+=s;return}const o=e.selectionStart||0,a=e.selectionEnd||0,r=_.value.content.slice(0,o),d=_.value.content.slice(a);_.value.content=r+s+d,ne(()=>{try{const y=o+s.length;e.focus(),e.setSelectionRange(y,y)}catch{}})},he=(s,e)=>{var y;const o=H.value[s],a=(o==null?void 0:o.textarea)||((y=o==null?void 0:o.$refs)==null?void 0:y.textarea),r=g(s);if(!a){r.input=(r.input||"")+e;return}const d=a.selectionStart||0,f=a.selectionEnd||0,v=(r.input||"").slice(0,d),I=(r.input||"").slice(f);r.input=v+e+I,ne(()=>{try{const $=d+e.length;a.focus(),a.setSelectionRange($,$)}catch{}})};return(s,e)=>{const o=x("el-icon"),a=x("el-button"),r=x("el-empty"),d=x("el-avatar"),f=x("el-image"),v=x("el-input"),I=x("el-popover"),y=x("el-radio"),$=x("el-radio-group"),J=x("el-form-item"),ke=x("el-form"),xe=x("el-dialog"),W=Ie("loading");return c(),p("div",Re,[i("div",Ue,[e[7]||(e[7]=i("h2",null,"动态",-1)),t(a,{type:"primary",onClick:e[0]||(e[0]=n=>T.value=!0)},{default:l(()=>[t(o,null,{default:l(()=>[t(w(be))]),_:1}),e[6]||(e[6]=m(" 发布动态 ",-1))]),_:1})]),te((c(),p("div",Le,[M.value.length===0&&!V.value?(c(),p("div",Ne,[t(r,{description:"暂无动态"})])):b("",!0),(c(!0),p(X,null,j(M.value,n=>{var Y,Z;return c(),p("div",{key:n.id,class:"moment-card"},[i("div",Ae,[t(d,{src:n.userAvatar||((Y=n.user)==null?void 0:Y.avatar),size:45},{default:l(()=>[t(o,null,{default:l(()=>[t(w(oe))]),_:1})]),_:1},8,["src"]),i("div",Fe,[i("div",Oe,C(n.username||((Z=n.user)==null?void 0:Z.nickname)),1),i("div",qe,C(K(n.createTime)),1)])]),i("div",Je,[n.content?(c(),p("div",Xe,C(n.content),1)):b("",!0),n.type==="song"?(c(),p("div",je,[i("div",{class:"share-item",onClick:u=>me(n.relatedId)},[t(f,{src:n.relatedCover,fit:"cover",class:"share-cover"},{error:l(()=>[i("div",He,[t(o,null,{default:l(()=>[t(w(le))]),_:1})])]),_:1},8,["src"]),i("div",Ke,[i("div",Qe,C(n.relatedTitle),1),e[8]||(e[8]=i("div",{class:"share-type"},"歌曲",-1))])],8,Ge)])):b("",!0),n.type==="playlist"?(c(),p("div",We,[i("div",{class:"share-item",onClick:u=>ge(n.relatedId)},[t(f,{src:n.relatedCover,fit:"cover",class:"share-cover"},{error:l(()=>[i("div",Ze,[t(o,null,{default:l(()=>[t(w(le))]),_:1})])]),_:1},8,["src"]),i("div",et,[i("div",tt,C(n.relatedTitle),1),e[9]||(e[9]=i("div",{class:"share-type"},"歌单",-1))])],8,Ye)])):b("",!0),n.images?(c(),p("div",st,[(c(!0),p(X,null,j(Q(n.images),(u,z)=>(c(),ae(f,{key:z,src:u,fit:"cover","preview-src-list":Q(n.images),"initial-index":z,class:"moment-image"},null,8,["src","preview-src-list","initial-index"]))),128))])):b("",!0)]),i("div",nt,[t(a,{text:"",type:"primary",onClick:u=>de(n),loading:L.value===n.id},{default:l(()=>[t(o,null,{default:l(()=>[t(w($e))]),_:1}),i("span",null,C(n.likeCount||0),1)]),_:2},1032,["onClick","loading"]),t(a,{text:"",type:"primary",onClick:u=>ce(n)},{default:l(()=>[t(o,null,{default:l(()=>[t(w(G))]),_:1}),i("span",null,C(n.commentCount||0),1)]),_:2},1032,["onClick"]),_e(n)?(c(),ae(a,{key:0,text:"",type:"danger",onClick:u=>fe(n),loading:N.value===n.id},{default:l(()=>[...e[10]||(e[10]=[m(" 删除 ",-1)])]),_:1},8,["onClick","loading"])):b("",!0)]),i("div",ot,[i("div",lt,[t(v,{modelValue:g(n.id).input,"onUpdate:modelValue":u=>g(n.id).input=u,type:"textarea",rows:2,placeholder:"写评论...",maxlength:"500","show-word-limit":"",ref_for:!0,ref:u=>re(n.id,u)},null,8,["modelValue","onUpdate:modelValue"]),i("div",at,[t(I,{placement:"top",width:340,trigger:"click"},{reference:l(()=>[t(a,{text:""},{default:l(()=>[t(o,null,{default:l(()=>[t(w(G))]),_:1}),e[11]||(e[11]=m(" 表情",-1))]),_:1})]),default:l(()=>[t(se,{onPick:u=>he(n.id,u)},null,8,["onPick"])]),_:2},1024),t(a,{type:"primary",loading:g(n.id).posting,onClick:u=>ve(n)},{default:l(()=>[...e[12]||(e[12]=[m("发表评论",-1)])]),_:1},8,["loading","onClick"])])]),te((c(),p("div",it,[g(n.id).items.length===0&&!g(n.id).loading?(c(),p("div",rt,[t(r,{description:"暂无评论"})])):(c(),p("div",ut,[(c(!0),p(X,null,j(g(n.id).items,u=>{var z,ee;return c(),p("div",{key:u.id,class:"comment-item"},[t(d,{src:u.userAvatar||((z=u.user)==null?void 0:z.avatar),size:32},{default:l(()=>[t(o,null,{default:l(()=>[t(w(oe))]),_:1})]),_:1},8,["src"]),i("div",dt,[i("div",ct,[i("span",vt,C(u.username||((ee=u.user)==null?void 0:ee.nickname)||"匿名用户"),1),i("span",ft,C(K(u.createTime)),1)]),i("div",pt,C(u.content),1)])])}),128))])),g(n.id).hasMore?(c(),p("div",_t,[t(a,{text:"",loading:g(n.id).loading,onClick:u=>q(n.id)},{default:l(()=>[...e[13]||(e[13]=[m("加载更多",-1)])]),_:1},8,["loading","onClick"])])):b("",!0)])),[[W,g(n.id).loading]])])])}),128))])),[[W,V.value]]),U.value?(c(),p("div",mt,[t(a,{text:"",loading:V.value,onClick:ue},{default:l(()=>[...e[14]||(e[14]=[m(" 加载更多 ",-1)])]),_:1},8,["loading"])])):b("",!0),t(xe,{modelValue:T.value,"onUpdate:modelValue":e[5]||(e[5]=n=>T.value=n),title:"发布动态",width:"600px"},{footer:l(()=>[t(a,{onClick:e[4]||(e[4]=n=>T.value=!1)},{default:l(()=>[...e[22]||(e[22]=[m("取消",-1)])]),_:1}),t(a,{type:"primary",onClick:pe,loading:A.value},{default:l(()=>[...e[23]||(e[23]=[m(" 发布 ",-1)])]),_:1},8,["loading"])]),default:l(()=>[t(ke,{model:_.value,"label-width":"80px"},{default:l(()=>[t(J,{label:"动态类型"},{default:l(()=>[t($,{modelValue:_.value.type,"onUpdate:modelValue":e[1]||(e[1]=n=>_.value.type=n)},{default:l(()=>[t(y,{value:"text"},{default:l(()=>[...e[15]||(e[15]=[m("纯文本",-1)])]),_:1}),t(y,{value:"song"},{default:l(()=>[...e[16]||(e[16]=[m("分享歌曲",-1)])]),_:1}),t(y,{value:"playlist"},{default:l(()=>[...e[17]||(e[17]=[m("分享歌单",-1)])]),_:1})]),_:1},8,["modelValue"])]),_:1}),t(J,{label:"内容"},{default:l(()=>[t(v,{modelValue:_.value.content,"onUpdate:modelValue":e[2]||(e[2]=n=>_.value.content=n),type:"textarea",rows:4,placeholder:"说点什么...",maxlength:"500","show-word-limit":"",ref_key:"publishInputRef",ref:F},null,8,["modelValue"]),i("div",gt,[t(I,{placement:"top",width:340,trigger:"click"},{reference:l(()=>[t(a,{text:""},{default:l(()=>[t(o,null,{default:l(()=>[t(w(G))]),_:1}),e[18]||(e[18]=m(" 表情",-1))]),_:1})]),default:l(()=>[t(se,{onPick:ye})]),_:1})])]),_:1}),t(J,{label:"可见范围"},{default:l(()=>[t($,{modelValue:_.value.visibility,"onUpdate:modelValue":e[3]||(e[3]=n=>_.value.visibility=n)},{default:l(()=>[t(y,{value:"public"},{default:l(()=>[...e[19]||(e[19]=[m("公开",-1)])]),_:1}),t(y,{value:"friends"},{default:l(()=>[...e[20]||(e[20]=[m("仅好友",-1)])]),_:1}),t(y,{value:"private"},{default:l(()=>[...e[21]||(e[21]=[m("仅自己",-1)])]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}},kt=Ce(yt,[["__scopeId","data-v-5987049e"]]);export{kt as default};
